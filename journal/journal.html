<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Master Planner - Barakah & Build</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Clean White-Dominated Palette */
            --primary: #2c3e50;
            /* Dark Blue-Gray */
            --secondary: #27ae60;
            /* Minimal Green Accent */
            --accent: #d4a373;
            /* Gold/Bronze Accent */
            --highlight: #f8f9fa;
            /* Very Light Gray */
            --bg-body: #ffffff;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-light: #6c757d;
            --border: #e9ecef;
            --shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.08), 0 1px 2px -1px rgba(0, 0, 0, 0.04);
            --font-display: 'Playfair Display', serif;
            --font-body: 'Inter', sans-serif;
        }

        /* --- GLOBAL STYLES --- */
        body {
            font-family: var(--font-body);
            color: var(--text-main);
            background: #ffffff;
            margin: 0;
            padding: 20px;
            transition: background 0.3s ease;
        }

        h1,
        h2,
        h3,
        h4 {
            font-family: var(--font-display);
            color: var(--primary);
            line-height: 1.2;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--secondary);
            padding-left: 15px;
        }

        h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.8rem;
            color: var(--secondary);
        }

        /* --- LAYOUT & CONTAINERS --- */
        .app-container {
            display: flex;
            gap: 15px;
            max-width: 100%;
            margin: 0;
            padding: 0 15px;
        }

        /* SIDEBAR / TOC */
        .sidebar {
            width: 20%;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
            height: calc(100vh - 40px);
            position: sticky;
            top: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                padding: 10px;
                gap: 10px;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                top: 0;
                order: 2;
                display: none;
                /* Hidden by default on mobile */
                margin-bottom: 20px;
            }

            .main-content {
                order: 1;
            }

            .grid-2 {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            .page {
                width: 90% !important;
                padding: 15mm !important;
                min-height: auto !important;
            }
        }

        /* Enhanced resizable inputs */
        .resizable-input {
            resize: vertical;
            min-height: 40px;
            max-height: 200px;
            overflow: auto;
        }

        .resizable-input:focus {
            min-height: 60px;
        }

        .sidebar h3 {
            text-align: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--primary);
            font-weight: 600;
            font-size: 0.9rem;
        }


        /* MAIN CONTENT AREA */
        .main-content {
            flex-grow: 1;
            /* width: calc(100% - 270px); */
        }

        /* CONTROLS (Floating) */
        .controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            flex-direction: column;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(30, 58, 52, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 52, 0.6);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        /* --- PLANNER PAGES (Printable) --- */
        .page {
            background: white;
            width: 100%;
            /* A4 */
            min-height: 297mm;
            margin: 0 auto 40px auto;
            padding: 10mm;
            box-sizing: border-box;
            box-shadow: var(--shadow);
            border-radius: 2px;
            position: relative;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- INPUTS & FORMS --- */
        textarea,
        input[type="text"],
        .editable {
            width: 100%;
            border: none;
            border-bottom: 1px dotted var(--border);
            font-family: var(--font-body);
            background: transparent;
            font-size: 0.95rem;
            padding: 8px 0;
            transition: all 0.2s;
            resize: none;
        }

        textarea:focus,
        input[type="text"]:focus {
            outline: none;
            border-bottom: 1px solid var(--secondary);
            background: rgba(232, 245, 233, 0.3);
        }

        /* --- COMPONENTS --- */
        .box-section {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: box-shadow 0.3s;
        }

        .box-section:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .box-title {
            display: block;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1.5px;
            color: var(--text-light);
            margin-bottom: 12px;
            font-weight: 700;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        /* --- CALENDAR WIDGET --- */
        .calendar-widget {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            text-align: center;
            font-size: 0.75rem;
        }

        .calendar-day-header {
            font-weight: 500;
            color: var(--text-light);
            padding: 4px 1px;
            font-size: 0.65rem;
            text-transform: uppercase;
        }

        .calendar-day {
            padding: 6px 2px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.7rem;
        }

        .calendar-day:hover {
            background: var(--highlight);
            border-color: var(--secondary);
        }

        .calendar-day.active {
            background: var(--secondary);
            color: white;
            font-weight: 600;
        }

        .calendar-day.empty {
            cursor: default;
            background: transparent;
        }

        .calendar-day.friday {
            color: var(--secondary);
            font-weight: 600;
        }

        /* --- PRAYER TIMES --- */
        .prayer-card {
            background: #ffffff;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }

        .prayer-card h4 {
            margin: 0 0 8px 0;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            color: var(--text-light);
        }

        .prayer-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .prayer-row:hover {
            background: var(--highlight);
            margin: 0 -4px;
            padding: 4px;
            border-radius: 3px;
        }

        .prayer-row:last-child {
            border-bottom: none;
        }

        .prayer-name {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
        }

        .prayer-time {
            font-weight: 600;
            background: var(--highlight);
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.7rem;
            color: var(--secondary);
        }

        /* SUN TIMES */
        .sun-times {
            background: #ffffff;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .sun-time-item {
            text-align: center;
            padding: 6px 4px;
            background: var(--highlight);
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .sun-time-item:hover {
            background: var(--border);
        }

        .sun-icon {
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .sun-label {
            font-size: 0.6rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .sun-time {
            font-weight: 600;
            font-size: 0.75rem;
        }

        /* --- 24H TRACKER & LISTS --- */
        .schedule-row {
            display: flex;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
        }

        .schedule-row.prayer-time {
            background: var(--highlight);
            border-left: 3px solid var(--secondary);
        }

        .time-col {
            width: 70px;
            font-size: 0.8rem;
            color: var(--text-light);
            padding: 8px;
            border-right: 1px solid #f0f0f0;
            flex-shrink: 0;
        }

        .task-col {
            flex-grow: 1;
            padding: 0 10px;
        }

        .task-col input {
            height: 100%;
            padding: 10px 0;
            font-size: 0.9rem;
        }

        .checkbox-list div {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .checkbox-list input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--secondary);
            border-radius: 4px;
            margin-right: 12px;
            cursor: pointer;
            position: relative;
        }

        .checkbox-list input[type="checkbox"]:checked {
            background: var(--secondary);
        }

        .checkbox-list input[type="checkbox"]:checked::after {
            content: '‚úì';
            color: white;
            position: absolute;
            left: 3px;
            top: -1px;
            font-size: 12px;
        }

        /* Enhanced task management */
        .task-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            position: relative;
        }

        .task-item input[type="text"] {
            flex-grow: 1;
        }

        .task-item .task-controls {
            display: flex;
            gap: 4px;
        }

        .task-btn {
            background: var(--highlight);
            border: 1px solid var(--border);
            color: var(--text-light);
            padding: 4px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }

        .task-btn:hover {
            background: var(--border);
        }

        .task-btn.delete:hover {
            background: #dc3545;
            color: white;
        }

        .add-task-btn {
            width: 100%;
            padding: 8px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 8px;
            transition: all 0.2s ease;
        }

        .add-task-btn:hover {
            background: #229954;
        }

        .btn-sm {
            padding: 3px 6px;
            font-size: 0.7rem;
            border-radius: 3px;
            background: var(--highlight);
            color: var(--text-light);
            transition: all 0.2s;
        }

        .btn-sm:hover {
            background: var(--border);
        }


        .print-btn-float {
            position: absolute;
            top: 20px;
            right: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .page:hover .print-btn-float {
            opacity: 1;
        }

        /* --- PRINT CSS --- */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }

            body {
                background: white;
                margin: 0;
                padding: 0;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .sidebar,
            .controls,
            .calendar-widget,
            .prayer-card,
            .print-btn-float,
            .task-controls,
            .add-task-btn,
            #sidebarToggle {
                display: none !important;
            }

            .app-container {
                display: block;
                padding: 0;
                margin: 0;
                max-width: none;
            }

            .main-content {
                width: 100%;
                margin: 0;
                padding: 0;
            }

            .page {
                width: 210mm;
                min-height: 297mm;
                padding: 5mm;
                margin: 0 auto;
                box-shadow: none;
                border: none;
                page-break-after: always;
                border-radius: 0;
                animation: none;
            }

            /* Make inputs look like static text */
            input,
            textarea {
                border: none !important;
                resize: none;
                background: transparent !important;
                padding: 4px 0;
            }

            ::placeholder {
                color: transparent;
            }

            /* Ensure Grid works in print */
            .grid-2 {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 20px !important;
            }
        }

        /* Footer Styling */
        .journal-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            color: var(--text-light);
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-quote {
            font-family: var(--font-display);
            font-style: italic;
            color: var(--primary);
        }

        @media print {
            .journal-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                border: none;
                font-size: 0.7rem;
                padding: 0 10mm 5mm 10mm;
            }
        }
    </style>
</head>

<body>

    <div class="app-container">
        <!-- NAVIGATION SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0;">Daily Journal</h3>
                <!-- Close button for mobile sidebar -->
                <button class="task-btn" onclick="toggleSidebar()" style="display: none;"
                    id="sidebarCloseBtn">‚úï</button>
            </div>

            <!-- Calendar Widget -->
            <div class="calendar-widget">
                <div class="calendar-header">
                    <button class="btn-sm" id="prevMonth"
                        style="border:none; background:none; cursor:pointer;">&lt;</button>
                    <span id="currentMonthYear" style="font-weight:bold; font-size:0.9rem;">Dec 2025</span>
                    <button class="btn-sm" id="nextMonth"
                        style="border:none; background:none; cursor:pointer;">&gt;</button>
                </div>
                <div class="calendar-grid" id="calendarDays">
                    <!-- JS generated days -->
                </div>
            </div>

            <!-- Sun Times Widget -->
            <div class="sun-times" id="sunTimesWidget">
                <div class="sun-time-item">
                    <div class="sun-icon">üåÖ</div>
                    <div class="sun-label">Sunrise</div>
                    <div class="sun-time" id="sunriseTime">--:--</div>
                </div>
                <div class="sun-time-item">
                    <div class="sun-icon">üåá</div>
                    <div class="sun-label">Sunset</div>
                    <div class="sun-time" id="sunsetTime">--:--</div>
                </div>
            </div>

            <!-- Prayer Times Summary -->
            <div class="prayer-card" id="sidebarPrayerTimes">
                <h4>Prayer Times</h4>
                <div id="prayerListSmall">
                    <!-- JS generated -->
                </div>
            </div>
        </div>

        <!-- FLOATING ACTION BUTTONS -->
        <div class="controls">
            <button class="btn" onclick="window.print()">
                <span>üñ®Ô∏è</span> Print Journal
            </button>
            <button class="btn btn-secondary" onclick="updateToToday()">
                <span>üìÖ</span> Today
            </button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- Mobile Header with Toggle -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; display: none;"
                id="mobileHeader">
                <h2 style="margin:0; font-size: 1.5rem;">My Journal</h2>
                <button class="btn-sm" onclick="toggleSidebar()"
                    style="font-size: 1.2rem; padding: 4px 10px;">‚ò∞</button>
            </div>
            <!-- DAILY PAGE -->
            <div id="daily" class="page">
                <div
                    style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px;">
                    <div>
                        <input type="text" id="dailyDate" placeholder="Date"
                            style="font-size: 1.5rem; font-weight: bold; color: var(--primary); width: 300px;">
                        <input type="text" id="dailyHijri" placeholder="Hijri Date"
                            style="font-size: 1rem; color: var(--text-light); width: 300px;">
                    </div>
                    <div style="width: 40%; text-align: right;">
                        <span class="box-title">Daily Intention</span>
                        <input type="text" id="dailyIntention" placeholder="Bismillah..."
                            style="text-align: right; font-style: italic;">
                    </div>
                </div>

                <div class="grid-2">
                    <!-- LEFT COLUMN: SCHEDULE -->
                    <div style="padding-right: 15px; border-right: 1px dashed var(--border);">
                        <div class="box-title" style="margin-bottom: 10px;">24-Hour Flow</div>
                        <div id="scheduleContainer">
                            <!-- Generated via JS for full 24h control -->
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: TASKS & REFLECTION -->
                    <div>
                        <div class="box-section" style="border-left: 4px solid var(--accent);">
                            <span class="box-title">üê∏ Eat The Frog (Top 3)</span>
                            <div id="eatTheFrogTasks" class="checkbox-list">
                                <!-- Tasks will be generated by JavaScript -->
                            </div>
                            <button class="add-task-btn" onclick="addTask('eatTheFrogTasks')">‚ûï Add Task</button>
                        </div>

                        <div class="box-section">
                            <span class="box-title">To-Do List</span>
                            <div id="todoListTasks" class="checkbox-list">
                                <!-- Tasks will be generated by JavaScript -->
                            </div>
                            <button class="add-task-btn" onclick="addTask('todoListTasks')">‚ûï Add Task</button>
                        </div>

                        <div class="box-section" style="background: var(--highlight);">
                            <span class="box-title">üß† 1% Better (Today I Learned)</span>
                            <textarea id="reflectionLearned" class="resizable-input" style="height: 50px;"
                                placeholder="Concept / Hadith / Code snippet"></textarea>
                        </div>

                        <div class="grid-2">
                            <div class="box-section">
                                <span class="box-title">Health</span>
                                <textarea id="reflectionHealth" class="resizable-input"
                                    placeholder="üíß Water intake / üèÉ Exercise routine / ü•ó Meal plan"
                                    style="height: 60px;"></textarea>
                            </div>
                            <div class="box-section">
                                <span class="box-title">Connection</span>
                                <textarea id="reflectionConnection" class="resizable-input"
                                    placeholder="Family time / Friend check-in / Community involvement"
                                    style="height: 60px;"></textarea>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div class="box-section">
                                <span class="box-title">Daily Muhasabah (Gratitude)</span>
                                <textarea id="reflectionGratitude" class="resizable-input"
                                    placeholder="Alhamdulillah for..." style="height: 60px;"></textarea>
                            </div>

                            <div class="box-section" style="background-color: #fff3cd; border: 1px solid #ffeaa7;">
                                <span class="box-title">Areas for Improvement</span>
                                <textarea id="reflectionImprovement" class="resizable-input"
                                    placeholder="What could I have done better today?" style="height: 80px;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- FOOTER -->
            <div class="journal-footer">
                <div class="footer-quote">"He who has a why to live can bear almost any how."</div>
                <div>2026 Master Planner ‚Ä¢ Barakah & Build</div>
            </div>

            <!-- JAVASCRIPT LOGIC -->
            <script>
                // --- CONFIG ---
                const PRAYER_METHOD = 2; // ISNA by default, can be dynamic
                // Simple Prayer Times Calculation (Approximation logic or API)
                // For this standalone file, we'll try to use Aladhan API if online, else fallback

                const state = {
                    currentDate: new Date(),
                    // Initialize with defaults to ensure UI is never empty
                    prayerTimes: { Fajr: "05:15", Sunrise: "06:30", Dhuhr: "12:00", Asr: "15:15", Sunset: "17:45", Maghrib: "17:45", Isha: "19:00" },
                    location: { lat: 23.8103, lng: 90.4125 }, // Default Dhaka, BD
                    taskIdCounter: 0,
                    tasks: {
                        eatTheFrogTasks: [],
                        todoListTasks: []
                    }
                };

                // --- INIT ---
                document.addEventListener('DOMContentLoaded', () => {
                    initCalendar();
                    initSchedule();
                    initTasks();
                    // Render initial state (defaults) immediately
                    updatePrayerDisplay(state.prayerTimes);
                    updateDailyView(state.currentDate);
                    setupAutoSave();

                });

                // --- TASK MANAGEMENT FUNCTIONS ---
                function initTasks() {
                    // Initialize default tasks
                    addTask('eatTheFrogTasks', 'Most Important Task');
                    addTask('eatTheFrogTasks', '');
                    addTask('eatTheFrogTasks', '');

                    addTask('todoListTasks', '');
                    addTask('todoListTasks', '');
                    addTask('todoListTasks', '');
                }

                function addTask(containerId, placeholder = '') {
                    const taskId = `task_${state.taskIdCounter++}`;
                    const task = {
                        id: taskId,
                        text: placeholder,
                        completed: false
                    };

                    state.tasks[containerId].push(task);
                    renderTasks(containerId);
                    saveTasks();
                }

                function deleteTask(containerId, taskId) {
                    state.tasks[containerId] = state.tasks[containerId].filter(task => task.id !== taskId);
                    renderTasks(containerId);
                    saveTasks();
                }

                function toggleTask(containerId, taskId) {
                    const task = state.tasks[containerId].find(task => task.id === taskId);
                    if (task) {
                        task.completed = !task.completed;
                        saveTasks();
                    }
                }

                function updateTaskText(containerId, taskId, text) {
                    const task = state.tasks[containerId].find(task => task.id === taskId);
                    if (task) {
                        task.text = text;
                        saveTasks();
                    }
                }

                function renderTasks(containerId) {
                    const container = document.getElementById(containerId);
                    if (!container) return;

                    container.innerHTML = '';

                    state.tasks[containerId].forEach(task => {
                        const taskDiv = document.createElement('div');
                        taskDiv.className = 'task-item';
                        taskDiv.innerHTML = `
                    <input type="checkbox" ${task.completed ? 'checked' : ''}
                           onchange="toggleTask('${containerId}', '${task.id}')">
                    <input type="text" value="${task.text}"
                           placeholder="${containerId === 'eatTheFrogTasks' ? 'Important task...' : 'Task...'}"
                           onchange="updateTaskText('${containerId}', '${task.id}', this.value)"
                           onfocus="this.select()">
                    <div class="task-controls">
                        <button class="task-btn delete" onclick="deleteTask('${containerId}', '${task.id}')">üóëÔ∏è</button>
                    </div>
                `;
                        container.appendChild(taskDiv);
                    });
                }

                function saveTasks() {
                    localStorage.setItem('dailyTasks', JSON.stringify(state.tasks));
                }

                function loadTasks() {
                    const saved = localStorage.getItem('dailyTasks');
                    if (saved) {
                        try {
                            state.tasks = JSON.parse(saved);
                        } catch (e) {
                            console.error('Error loading tasks:', e);
                        }
                    }
                }

                function toggleSidebar() {
                    const sidebar = document.getElementById('sidebar');
                    const isHidden = sidebar.style.display === 'none';
                    sidebar.style.display = isHidden ? 'flex' : 'none';
                }

                // Initialize mobile sidebar toggle on load
                function initializeMobileSidebar() {
                    const mobileHeader = document.getElementById('mobileHeader');
                    const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');

                    if (window.innerWidth <= 768) {
                        mobileHeader.style.display = 'flex';
                        sidebarCloseBtn.style.display = 'block';
                    } else {
                        mobileHeader.style.display = 'none';
                        sidebarCloseBtn.style.display = 'none';
                        document.getElementById('sidebar').style.display = 'flex';
                    }
                }

                // Listen for window resize
                window.addEventListener('resize', initializeMobileSidebar);
                document.addEventListener('DOMContentLoaded', initializeMobileSidebar);

                function printSection(id) {
                    // Remove previous active classes
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('print-active'));
                    document.body.classList.add('printing-section');

                    // Add active class to target
                    const el = document.getElementById(id);
                    if (el) {
                        el.classList.add('print-active');
                        window.print();
                    }

                    // Cleanup after print (timeout to ensure print dialog captures state)
                    setTimeout(() => {
                        document.body.classList.remove('printing-section');
                        el.classList.remove('print-active');
                    }, 1000);
                }

                // --- CALENDAR LOGIC ---
                function initCalendar() {
                    const calendarDays = document.getElementById('calendarDays');
                    const monthLabel = document.getElementById('currentMonthYear');

                    const renderCalendar = (date) => {
                        calendarDays.innerHTML = '';
                        // Add Day Headers
                        ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => {
                            const h = document.createElement('div');
                            h.className = 'calendar-day-header';
                            h.innerText = d;
                            calendarDays.appendChild(h);
                        });

                        const year = date.getFullYear();
                        const month = date.getMonth();

                        monthLabel.innerText = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

                        const firstDay = new Date(year, month, 1).getDay();
                        const daysInMonth = new Date(year, month + 1, 0).getDate();

                        // Empty slots
                        for (let i = 0; i < firstDay; i++) {
                            const d = document.createElement('div');
                            d.className = 'calendar-day empty';
                            calendarDays.appendChild(d);
                        }

                        // Days
                        for (let i = 1; i <= daysInMonth; i++) {
                            const d = document.createElement('div');
                            d.className = 'calendar-day';
                            d.innerText = i;

                            // Check if this is a Friday
                            const dayOfWeek = new Date(year, month, i).getDay();
                            if (dayOfWeek === 5) { // Friday is day 5 (0 = Sunday)
                                d.classList.add('friday');
                            }

                            if (i === state.currentDate.getDate() && month === state.currentDate.getMonth() && year === state.currentDate.getFullYear()) {
                                d.classList.add('active');
                            }

                            d.onclick = () => {
                                state.currentDate = new Date(year, month, i);
                                renderCalendar(state.currentDate);
                                updateDailyView(state.currentDate);
                            };

                            calendarDays.appendChild(d);
                        }
                    };

                    renderCalendar(state.currentDate);

                    // Controls
                    document.getElementById('prevMonth').onclick = () => {
                        state.currentDate.setMonth(state.currentDate.getMonth() - 1);
                        renderCalendar(state.currentDate);
                    };
                    document.getElementById('nextMonth').onclick = () => {
                        state.currentDate.setMonth(state.currentDate.getMonth() + 1);
                        renderCalendar(state.currentDate);
                    };
                }

                function updateToToday() {
                    state.currentDate = new Date();
                    initCalendar();
                    updateDailyView(state.currentDate);
                }

                // --- SCHEDULE & PRAYER TIMES ---
                async function updateDailyView(date) {
                    try {
                        // Load tasks
                        loadTasks();
                        renderTasks('eatTheFrogTasks');
                        renderTasks('todoListTasks');

                        // Update Headers
                        const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                        const dailyDateEl = document.getElementById('dailyDate');
                        if (dailyDateEl) {
                            dailyDateEl.value = date.toLocaleDateString('en-US', options);
                        }

                        // Error source: 'monthInput' does not exist in HTML. Removing or making optional.
                        const monthInputEl = document.getElementById('monthInput');
                        if (monthInputEl) {
                            monthInputEl.value = date.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
                        }

                        // Fetch Hijri & Prayer Times logic here
                        // Mocking Hijri for now or using Intl if available
                        const hijriDate = new Intl.DateTimeFormat('en-u-ca-islamic', { day: 'numeric', month: 'short', year: 'numeric' }).format(date);
                        const dailyHijriEl = document.getElementById('dailyHijri');
                        if (dailyHijriEl) {
                            dailyHijriEl.value = hijriDate;
                        }

                        await fetchPrayerTimes(date);
                        renderEnhancedSchedule(date);
                    } catch (err) {
                        console.error("Critical Error in updateDailyView:", err);
                    }
                }

                async function fetchPrayerTimes(date) {
                    // Proper date formatting DD-MM-YYYY
                    const d = String(date.getDate()).padStart(2, '0');
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const y = date.getFullYear();
                    const formattedDate = `${d}-${m}-${y}`;

                    const url = `https://api.aladhan.com/v1/timings/${formattedDate}?latitude=${state.location.lat}&longitude=${state.location.lng}&method=${PRAYER_METHOD}&_=${new Date().getTime()}`;
                    console.log('Fetching prayer times from:', url);

                    try {
                        const res = await fetch(url);
                        console.log('API Response status:', res.status);
                        const data = await res.json();
                        console.log('API Data:', data);

                        if (data.code === 200 && data.data && data.data.timings) {
                            state.prayerTimes = data.data.timings;
                            updatePrayerDisplay(state.prayerTimes);
                        } else {
                            throw new Error('Invalid API response');
                        }
                    } catch (e) {
                        console.warn("Using offline/default prayer times due to error:", e);
                        if (!state.prayerTimes) {
                            state.prayerTimes = { Fajr: "05:15", Sunrise: "06:30", Dhuhr: "12:00", Asr: "15:15", Sunset: "17:45", Maghrib: "17:45", Isha: "19:00" };
                            updatePrayerDisplay(state.prayerTimes);
                        }
                    }
                }

                function updatePrayerDisplay(times) {
                    const summary = document.getElementById('prayerListSmall');
                    if (!summary) return;

                    // Update sun times - prefer Sunset key if available, else Maghrib
                    document.getElementById('sunriseTime').textContent = times.Sunrise || '--:--';
                    document.getElementById('sunsetTime').textContent = times.Sunset || times.Maghrib || '--:--';

                    // Update prayer times with icons and better styling
                    summary.innerHTML = `
                <div class="prayer-row">
                    <span class="prayer-name">üåô Fajr</span>
                    <span class="prayer-time">${times.Fajr}</span>
                </div>
                <div class="prayer-row">
                    <span class="prayer-name">‚òÄÔ∏è Duha</span>
                    <span class="prayer-time">${times.Sunrise}</span>
                </div>
                <div class="prayer-row">
                    <span class="prayer-name">‚òÄÔ∏è Dhuhr</span>
                    <span class="prayer-time">${times.Dhuhr}</span>
                </div>
                <div class="prayer-row">
                    <span class="prayer-name">üåÖ Asr</span>
                    <span class="prayer-time">${times.Asr}</span>
                </div>
                <div class="prayer-row">
                    <span class="prayer-name">üåá Maghrib</span>
                    <span class="prayer-time">${times.Maghrib}</span>
                </div>
                <div class="prayer-row">
                    <span class="prayer-name">üåô Isha</span>
                    <span class="prayer-time">${times.Isha}</span>
                </div>
            `;
                }

                function initSchedule() {
                    // Initial render
                    renderEnhancedSchedule(state.currentDate);
                }

                function renderEnhancedSchedule(date) {
                    const container = document.getElementById('scheduleContainer');
                    container.innerHTML = '';

                    const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
                    const prayerMarkers = state.prayerTimes ? {
                        Fajr: state.prayerTimes.Fajr,
                        Sunrise: state.prayerTimes.Sunrise,
                        Dhuhr: state.prayerTimes.Dhuhr,
                        Asr: state.prayerTimes.Asr,
                        Maghrib: state.prayerTimes.Maghrib,
                        Isha: state.prayerTimes.Isha
                    } : {};

                    // Helper function to get prayer time in minutes
                    const getPrayerMinutes = (timeStr) => {
                        if (!timeStr) return null;
                        const [h, m] = timeStr.split(':').map(Number);
                        return h * 60 + m;
                    };

                    for (let i = 4; i < 28; i++) { // 4 AM to 4 AM next day
                        let displayHour = i % 24;
                        let displayTime = displayHour.toString().padStart(2, '0') + ":00";
                        let isPrayerTime = false;
                        let prayerInfo = "";
                        let placeholder = "";
                        let rowClass = "schedule-row";

                        // Check for prayer times
                        for (const [prayerName, prayerTime] of Object.entries(prayerMarkers)) {
                            if (prayerTime) {
                                const prayerHour = parseInt(prayerTime.split(':')[0]);
                                const prayerMinute = parseInt(prayerTime.split(':')[1]);

                                if (prayerHour === displayHour ||
                                    (displayHour === 5 && prayerName === 'Fajr' && prayerHour < 5) ||
                                    (displayHour === 18 && prayerName === 'Maghrib' && prayerHour >= 18)) {

                                    isPrayerTime = true;
                                    prayerInfo = `${prayerName} (${prayerTime})`;
                                    rowClass = "schedule-row prayer-time";
                                    break;
                                }
                            }
                        }

                        // Dynamic scheduling based on day of week
                        if (dayOfWeek >= 3 && dayOfWeek <= 6) { // Wednesday to Saturday
                            if (displayHour === 6 && displayHour < 7) {
                                placeholder = "Morning Class (6:30-7:30)";
                                rowClass = "schedule-row prayer-time";
                            }
                        }

                        // Qailulah time (after Fajr until sunrise)
                        if (prayerMarkers.Fajr && prayerMarkers.Sunrise) {
                            const fajrMinutes = getPrayerMinutes(prayerMarkers.Fajr);
                            const sunriseMinutes = getPrayerMinutes(prayerMarkers.Sunrise);
                            const currentMinutes = displayHour * 60;

                            if (currentMinutes >= fajrMinutes && currentMinutes < sunriseMinutes) {
                                if (displayHour === parseInt(prayerMarkers.Fajr.split(':')[0]) ||
                                    (displayHour > parseInt(prayerMarkers.Fajr.split(':')[0]) &&
                                        displayHour < parseInt(prayerMarkers.Sunrise.split(':')[0]))) {
                                    placeholder = "‚è∞ Qailulah Time (Recommended Duha)";
                                    rowClass = "schedule-row prayer-time";
                                }
                            }
                        }

                        // Office time (Monday to Friday)
                        if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Monday to Friday
                            if (displayHour >= 9 && displayHour < 18) {
                                placeholder = "Office Hours";
                                if (!isPrayerTime) rowClass = "schedule-row";
                            }
                        }

                        // General placeholders
                        if (!placeholder) {
                            if (displayHour === 5) placeholder = "Wake up & Fajr preparation";
                            else if (displayHour === 7) placeholder = "Breakfast & family time";
                            else if (displayHour === 8) placeholder = "Commute / Prepare for work";
                            else if (displayHour === 12) placeholder = "Lunch break & Dhuhr";
                            else if (displayHour === 13) placeholder = "Afternoon work";
                            else if (displayHour === 15) placeholder = "Asr break";
                            else if (displayHour === 19) placeholder = "Dinner & family time";
                            else if (displayHour === 20) placeholder = "Evening activities";
                            else if (displayHour === 21) placeholder = "Relaxation & Isha";
                            else if (displayHour === 22) placeholder = "Wind down routine";
                            else if (displayHour === 23) placeholder = "Sleep preparation";
                        }

                        // Create row
                        const row = document.createElement('div');
                        row.className = rowClass;

                        const prayerLabel = isPrayerTime ? ` üïå ${prayerInfo}` : '';

                        // Generate a unique ID for the schedule input based on date and hour
                        const scheduleKey = `schedule-${date.getDate()}-${date.getMonth()}-${date.getFullYear()}-${displayHour}`;

                        row.innerHTML = `
                    <div class="time-col">${displayTime}</div>
                    <div class="task-col">
                        <input type="text"
                               id="${scheduleKey}"
                               class="schedule-input"
                               data-key="${scheduleKey}"
                               placeholder="${placeholder}${prayerLabel}"
                               ${isPrayerTime ? 'style="font-weight: 600; color: var(--secondary);"' : ''}
                               onchange="saveScheduleInput('${scheduleKey}', this.value)">
                    </div>
                `;
                        container.appendChild(row);
                    }
                    // Restore values after rendering
                    loadScheduleInputs();
                }

                function saveScheduleInput(key, value) {
                    const data = JSON.parse(localStorage.getItem('journalSchedule') || '{}');
                    data[key] = value;
                    localStorage.setItem('journalSchedule', JSON.stringify(data));
                }

                function loadScheduleInputs() {
                    const data = JSON.parse(localStorage.getItem('journalSchedule') || '{}');
                    document.querySelectorAll('.schedule-input').forEach(input => {
                        const key = input.getAttribute('data-key');
                        if (data[key]) {
                            input.value = data[key];
                        }
                    });
                }

                // Generic Text Input Saver
                function setupAutoSave() {
                    const ids = ['dailyIntention', 'reflectionLearned', 'reflectionHealth', 'reflectionConnection', 'reflectionGratitude', 'reflectionImprovement'];

                    ids.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            // Load
                            const saved = localStorage.getItem('journal_' + id);
                            if (saved) el.value = saved;

                            // Save
                            el.addEventListener('input', () => {
                                localStorage.setItem('journal_' + id, el.value);
                            });
                        }
                    });
                }

            </script>
</body>

</html>